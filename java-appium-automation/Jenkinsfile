pipeline {
    agent any
    
    environment {
        MAVEN_HOME = tool 'Maven'
        JAVA_HOME = tool 'JDK11'
        PATH = "${MAVEN_HOME}/bin:${JAVA_HOME}/bin:${PATH}"
        APPIUM_SERVER = 'http://127.0.0.1:4723'
        DEVICE_NAME = 'Android_Device'
        PLATFORM_VERSION = '11'
    }
    
    parameters {
        choice(
            name: 'TEST_SUITE',
            choices: ['smoke-tests', 'regression-tests', 'all-tests'],
            description: 'Select test suite to execute'
        )
        booleanParam(
            name: 'GENERATE_REPORTS',
            defaultValue: true,
            description: 'Generate ExtentReports after execution'
        )
        string(
            name: 'DEVICE_UDID',
            defaultValue: 'PZPVSC95GMKNGUBQ',
            description: 'Device UDID for test execution'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }
        
        stage('Environment Setup') {
            steps {
                echo 'Setting up test environment...'
                script {
                    // Check if Appium server is running
                    def appiumStatus = sh(
                        script: "curl -s ${APPIUM_SERVER}/status || echo 'Appium not running'",
                        returnStdout: true
                    ).trim()
                    
                    if (appiumStatus.contains('Appium not running')) {
                        error 'Appium server is not running. Please start Appium server.'
                    }
                    
                    echo "Appium server is running: ${appiumStatus}"
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building the project...'
                dir('java-appium-automation') {
                    sh 'mvn clean compile'
                }
            }
        }
        
        stage('Test Execution') {
            steps {
                echo "Executing ${params.TEST_SUITE} test suite..."
                dir('java-appium-automation') {
                    script {
                        def testSuite = params.TEST_SUITE
                        def suiteFile = "src/test/resources/suites/${testSuite}.xml"
                        
                        sh """
                            mvn test -Dsurefire.suiteXmlFiles=${suiteFile} \
                                    -Ddevice.name=${params.DEVICE_UDID} \
                                    -Dplatform.version=${PLATFORM_VERSION} \
                                    -Dappium.server=${APPIUM_SERVER}
                        """
                    }
                }
            }
            post {
                always {
                    // Archive test results
                    dir('java-appium-automation') {
                        archiveArtifacts artifacts: 'target/surefire-reports/**/*', allowEmptyArchive: true
                        publishTestResults testResultsPattern: 'target/surefire-reports/TEST-*.xml'
                    }
                }
            }
        }
        
        stage('Generate Reports') {
            when {
                expression { params.GENERATE_REPORTS }
            }
            steps {
                echo 'Generating test reports...'
                dir('java-appium-automation') {
                    script {
                        // Archive ExtentReports
                        archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
                        
                        // Publish HTML reports
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: 'reports',
                            reportFiles: '*.html',
                            reportName: 'Appium Test Report',
                            reportTitles: 'Mobile Automation Test Results'
                        ])
                    }
                }
            }
        }
        
        stage('Notification') {
            steps {
                echo 'Sending notifications...'
                script {
                    def testResults = readFile('java-appium-automation/target/surefire-reports/emailable-report.html')
                    
                    // Email notification (configure email settings in Jenkins)
                    emailext (
                        subject: "Mobile Test Execution - ${currentBuild.currentResult}",
                        body: """
                            <h2>Mobile Automation Test Results</h2>
                            <p><strong>Build:</strong> ${env.BUILD_NUMBER}</p>
                            <p><strong>Status:</strong> ${currentBuild.currentResult}</p>
                            <p><strong>Test Suite:</strong> ${params.TEST_SUITE}</p>
                            <p><strong>Device:</strong> ${params.DEVICE_UDID}</p>
                            <p><strong>Reports:</strong> <a href="${env.BUILD_URL}Appium_Test_Report/">View Reports</a></p>
                            
                            <h3>Quick Summary:</h3>
                            ${testResults}
                        """,
                        mimeType: 'text/html',
                        to: 'asim.kumar.singh@company.com'
                    )
                }
            }
        }
    }
    
    post {
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check logs for details.'
        }
    }
}
