pipeline {
    agent any

    environment {
        PYTHON_HOME = 'C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313'
        PATH = "C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313;C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313\\Scripts;${env.PATH}"
    }

    parameters {
        choice(
            name: 'TEST_SUITE',
            choices: ['smoke', 'regression', 'cross_browser', 'api'],
            description: 'Select test suite to execute'
        )
        choice(
            name: 'BROWSER_TYPE',
            choices: ['chrome', 'firefox', 'edge', 'safari'],
            description: 'Single browser (used when MULTI_BROWSER=false)'
        )
        choice(
            name: 'ENVIRONMENT',
            choices: ['qa', 'staging', 'production'],
            description: 'Select environment for testing'
        )
        booleanParam(
            name: 'HEADLESS_MODE',
            defaultValue: false,
            description: 'Run tests in headless mode (false = visible browser for demo)'
        )
        booleanParam(
            name: 'PARALLEL_EXECUTION',
            defaultValue: true,
            description: 'Execute tests in parallel (pytest-xdist for faster execution)'
        )
        string(
            name: 'BROWSERS',
            defaultValue: 'chrome,firefox,edge',
            description: 'Comma-separated browsers for parallel execution (e.g., chrome,firefox,edge)'
        )
        booleanParam(
            name: 'MULTI_BROWSER',
            defaultValue: true,
            description: 'Run multiple browsers in parallel (for demo)'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out Python Selenium automation code..."
                checkout scm
            }
        }

        stage('Environment Setup') {
            steps {
                script {
                    dir('python-selenium-automation') {
                        bat """
                            "${PYTHON_HOME}\\python.exe" -m venv venv
                            call venv\\Scripts\\activate.bat
                            python -m pip install --upgrade pip --quiet
                            pip install -r requirements.txt --quiet
                        """
                    }
                }
            }
        }

        stage('Test Execution') {
            steps {
                script {
                    def parallelFlag = params.PARALLEL_EXECUTION ? '-n auto' : ''
                    
                    if (params.MULTI_BROWSER) {
                        // Multi-browser parallel execution for demo
                        def browsers = params.BROWSERS.split(',')*.trim().findAll { it }
                        def parallelTasks = [:]
                        
                        browsers.each { browser ->
                            parallelTasks["${browser}"] = {
                                dir('python-selenium-automation') {
                                    echo "Running tests on ${browser}..."
                                    bat """
                                        call venv\\Scripts\\activate.bat
                                        python -m pytest tests/ ${parallelFlag} --browser=${browser} --environment=${params.ENVIRONMENT} --headless=${params.HEADLESS_MODE} --html=reports/report_${browser}.html --self-contained-html -v
                                    """
                                }
                            }
                        }
                        
                        parallel parallelTasks
                    } else {
                        // Single browser execution
                        dir('python-selenium-automation') {
                            bat """
                                call venv\\Scripts\\activate.bat
                                python -m pytest tests/ ${parallelFlag} --browser=${params.BROWSER_TYPE} --environment=${params.ENVIRONMENT} --headless=${params.HEADLESS_MODE} --html=reports/report.html --self-contained-html -v
                            """
                        }
                    }
                }
            }
        }

        stage('Reports') {
            steps {
                dir('python-selenium-automation') {
                    script {
                        try {
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'reports',
                                reportFiles: 'report.html',
                                reportName: 'Python Test Report'
                            ])
                            archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
                        } catch (Exception e) {}
                    }
                }
            }
        }

        stage('Notification') {
            steps {
                script {
                    try {
                        emailext(
                            subject: "Python Selenium - ${currentBuild.currentResult}",
                            body: "Build: ${env.BUILD_NUMBER} | Browser: ${params.BROWSER_TYPE} | Headless: ${params.HEADLESS_MODE}",
                            to: "ashokchandravanshi1988@gmail.com"
                        )
                    } catch (Exception e) {}
                }
            }
        }
    }

    post {
        always {
            script {
                try {
                    dir('python-selenium-automation') {
                        bat "if exist venv rmdir /s /q venv 2>nul"
                    }
                } catch (Exception e) {}
            }
            cleanWs()
        }
        success { echo "Pipeline completed successfully!" }
        failure { echo "Pipeline failed!" }
    }
}
