pipeline {
    agent any

    environment {
        // Use full Python path for Windows Jenkins compatibility
        PYTHON_HOME = 'C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313'
        PATH = "C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313;C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313\\Scripts;C:\\Windows\\System32;${PATH}"
    }

    parameters {
        choice(
            name: 'TEST_SUITE',
            choices: ['smoke', 'regression', 'full'],
            description: 'Select test suite to execute'
        )
        choice(
            name: 'BROWSER_TYPE',
            choices: ['chrome', 'firefox', 'edge'],
            description: 'Single browser (used when MULTI_BROWSER=false)'
        )
        choice(
            name: 'ENVIRONMENT',
            choices: ['qa', 'staging', 'production'],
            description: 'Select environment for testing'
        )
        booleanParam(
            name: 'HEADLESS_MODE',
            defaultValue: false,
            description: 'Run tests in headless mode (true = faster but invisible, false = visible browser for demo)'
        )
        booleanParam(
            name: 'PARALLEL_EXECUTION',
            defaultValue: false,
            description: 'Execute tests in parallel (pytest-xdist for faster execution)'
        )
        string(
            name: 'BROWSERS',
            defaultValue: 'chrome',
            description: 'Comma-separated browsers for execution (e.g., chrome,firefox)'
        )
        booleanParam(
            name: 'MULTI_BROWSER',
            defaultValue: false,
            description: 'Run multiple browsers (for demo)'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out Python Selenium automation code..."
                checkout scm
            }
        }

        stage('Environment Setup') {
            steps {
                script {
                    dir('python-selenium-automation') {
                        bat """
                            echo Setting up Python environment...
                            echo Checking Python installation...
                            py --version
                            if errorlevel 1 (
                                echo Python not found in PATH
                                exit /b 1
                            )
                            echo Upgrading pip...
                            py -m pip install --upgrade pip --quiet
                            echo Installing requirements...
                            py -m pip install -r requirements.txt --quiet
                            echo Environment setup completed
                        """
                    }
                }
            }
        }

        stage('Test Execution') {
            steps {
                script {
                    def parallelFlag = params.PARALLEL_EXECUTION ? '-n auto' : ''
                    
                    dir('python-selenium-automation') {
                        bat """
                            echo Starting test execution...
                            set HEADLESS=${params.HEADLESS_MODE}
                            py -m pytest tests/ ${parallelFlag} -v --html=reports/report.html --self-contained-html
                        """
                    }
                }
            }
        }

        stage('Reports') {
            steps {
                dir('python-selenium-automation') {
                    script {
                        try {
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'reports',
                                reportFiles: 'report.html',
                                reportName: 'Python Test Report'
                            ])
                            archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
                        } catch (Exception e) {
                            echo "Report publishing failed: ${e.getMessage()}"
                        }
                    }
                }
            }
        }

        stage('Notification') {
            steps {
                dir('python-selenium-automation') {
                    script {
                        try {
                            emailext(
                                subject: "Python Selenium - ${currentBuild.currentResult}",
                                body: """<html>
                                    <body>
                                        <h2>Python Selenium Test Report</h2>
                                        <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
                                        <p><strong>Status:</strong> ${currentBuild.currentResult}</p>
                                        <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
                                        <p><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                                        <hr>
                                        <p><strong>Test Suite:</strong> ${params.TEST_SUITE}</p>
                                        <p><strong>Browser:</strong> ${params.BROWSER_TYPE}</p>
                                        <p><strong>Environment:</strong> ${params.ENVIRONMENT}</p>
                                        <p><strong>Headless Mode:</strong> ${params.HEADLESS_MODE}</p>
                                        <hr>
                                        <p><strong>HTML Report:</strong> See attached report.html</p>
                                        <p>Full test results are available in Jenkins artifacts.</p>
                                    </body>
                                </html>""",
                                to: "ashokchandravanshi1988@gmail.com",
                                mimeType: 'text/html',
                                attachLog: true,
                                attachmentsPattern: 'reports/report.html',
                                replyTo: 'ashokchandravanshi1988@gmail.com'
                            )
                        } catch (Exception e) {
                            echo "Notification failed: ${e.getMessage()}"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                try {
                    dir('python-selenium-automation') {
                        bat "if exist venv rmdir /s /q venv 2>nul"
                    }
                } catch (Exception e) {
                    echo "Cleanup failed: ${e.getMessage()}"
                }
            }
            cleanWs()
        }
        success { echo "Pipeline completed successfully!" }
        failure { echo "Pipeline failed!" }
    }
}