pipeline {
    agent any

    environment {
        // Use full Python path for Windows Jenkins compatibility
        PYTHON_HOME = 'C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313'
        PATH = "C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313;C:\\Users\\Asim\\AppData\\Local\\Programs\\Python\\Python313\\Scripts;C:\\Windows\\System32;${PATH}"
    }

    parameters {
        choice(
            name: 'TEST_SUITE',
            choices: ['smoke', 'regression', 'full'],
            description: 'Select test suite to execute'
        )
        choice(
            name: 'BROWSER_TYPE',
            choices: ['chrome', 'firefox', 'edge'],
            description: 'Single browser (used when MULTI_BROWSER=false)'
        )
        choice(
            name: 'ENVIRONMENT',
            choices: ['qa', 'staging', 'production'],
            description: 'Select environment for testing'
        )
        booleanParam(
            name: 'HEADLESS_MODE',
            defaultValue: false,
            description: 'Run tests in headless mode (true = faster but invisible, false = visible browser for demo)'
        )
        booleanParam(
            name: 'PARALLEL_EXECUTION',
            defaultValue: false,
            description: 'Execute tests in parallel (pytest-xdist for faster execution)'
        )
        string(
            name: 'BROWSERS',
            defaultValue: 'chrome',
            description: 'Comma-separated browsers for execution (e.g., chrome,firefox)'
        )
        booleanParam(
            name: 'MULTI_BROWSER',
            defaultValue: false,
            description: 'Run multiple browsers (for demo)'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out Python Selenium automation code..."
                checkout scm
            }
        }

        stage('Environment Setup') {
            steps {
                script {
                    dir('python-selenium-automation') {
                        bat """
                            echo Setting up Python environment...
                            echo Checking Python installation...
                            python --version
                            if errorlevel 1 (
                                echo Python not found in PATH
                                exit /b 1
                            )
                            echo Upgrading pip...
                            python -m pip install --upgrade pip --quiet
                            echo Installing requirements...
                            pip install -r requirements.txt --quiet
                            echo Environment setup completed
                        """
                    }
                }
            }
        }

        stage('Test Execution') {
            steps {
                script {
                    def parallelFlag = params.PARALLEL_EXECUTION ? '-n auto' : ''
                    
                    dir('python-selenium-automation') {
                        bat """
                            echo Starting test execution...
                            set HEADLESS=${params.HEADLESS_MODE}
                            python -m pytest tests/ ${parallelFlag} -v --html=reports/report.html --self-contained-html
                        """
                    }
                }
            }
        }

        stage('Reports') {
            steps {
                dir('python-selenium-automation') {
                    script {
                        try {
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'reports',
                                reportFiles: 'report.html',
                                reportName: 'Python Test Report'
                            ])
                            archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
                        } catch (Exception e) {
                            echo "Report publishing failed: ${e.getMessage()}"
                        }
                    }
                }
            }
        }

        stage('Notification') {
            steps {
                script {
                    try {
                        emailext(
                            subject: "Python Selenium - ${currentBuild.currentResult}",
                            body: "Build: ${env.BUILD_NUMBER} | Status: ${currentBuild.currentResult}",
                            to: "ashokchandravanshi1988@gmail.com"
                        )
                    } catch (Exception e) {
                        echo "Notification failed: ${e.getMessage()}"
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                try {
                    dir('python-selenium-automation') {
                        bat "if exist venv rmdir /s /q venv 2>nul"
                    }
                } catch (Exception e) {
                    echo "Cleanup failed: ${e.getMessage()}"
                }
            }
            cleanWs()
        }
        success { echo "Pipeline completed successfully!" }
        failure { echo "Pipeline failed!" }
    }
}