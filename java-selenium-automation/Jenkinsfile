pipeline {
    agent any

    environment {
        MAVEN_HOME = 'C:\\\\Program Files\\\\Maven\\\\ApacheMaven\\\\apache-maven-3.9.11'
        JAVA_HOME = 'C:\\\\Program Files\\\\Java\\\\jdk-24'
        PATH = "C:\\\\Program Files\\\\Java\\\\jdk-24\\\\bin;C:\\\\Program Files\\\\Maven\\\\ApacheMaven\\\\apache-maven-3.9.11\\\\bin;${env.PATH}"
    }

    parameters {
        choice(name: 'TEST_SUITE', choices: ['smoke-tests', 'regression-tests'], description: 'Test suite')
        choice(name: 'BROWSER_TYPE', choices: ['chrome', 'firefox', 'edge'], description: 'Single browser (used when MULTI_BROWSER=false)')
        choice(name: 'ENVIRONMENT', choices: ['qa', 'staging', 'production'], description: 'Environment')
        booleanParam(name: 'HEADLESS_MODE', defaultValue: false, description: 'Headless mode (true = faster but invisible, false = visible browser for demo)')
        booleanParam(name: 'MULTI_BROWSER', defaultValue: false, description: 'Run multiple browsers in parallel (enable for demo, but may cause delays)')
        string(name: 'BROWSERS', defaultValue: 'chrome,firefox,edge', description: 'Comma-separated browsers for parallel execution (only used when MULTI_BROWSER=true)')
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build & Test') {
            steps {
                script {
                    def suiteFile = params.TEST_SUITE == 'smoke-tests' ? 'selenium-smoke-tests.xml' : 'selenium-regression-tests.xml'
                    
                    if (params.MULTI_BROWSER) {
                        // Multi-browser parallel execution for demo
                        def browserList = params.BROWSERS.split(',')
                        def browsers = []
                        for (int i = 0; i < browserList.size(); i++) {
                            def b = browserList[i].trim()
                            if (b) {
                                browsers.add(b)
                            }
                        }
                        
                        def parallelTasks = [:]
                        for (int i = 0; i < browsers.size(); i++) {
                            // CRITICAL: Create local copy to avoid closure variable capture issue
                            def browserName = browsers[i]
                            parallelTasks["${browserName}"] = {
                                try {
                                    dir('java-selenium-automation') {
                                        echo "Running tests on ${browserName}..."
                                        // Use separate build directory per browser to prevent file locking
                                        bat "mvn clean test -Dmaven.test.failure.ignore=true -Dsurefire.suiteXmlFiles=src/test/resources/suites/${suiteFile} -Dbrowser=${browserName} -Denvironment=${params.ENVIRONMENT} -Dheadless=${params.HEADLESS_MODE} -Dbuild.directory=target-${browserName}"
                                    }
                                } catch (Exception e) {
                                    echo "Tests failed on ${browserName}: ${e.getMessage()}"
                                    throw e
                                }
                            }
                        }
                        
                        parallel parallelTasks
                    } else {
                        // Single browser execution
                        dir('java-selenium-automation') {
                            bat "mvn clean test -Dsurefire.suiteXmlFiles=src/test/resources/suites/${suiteFile} -Dbrowser=${params.BROWSER_TYPE} -Denvironment=${params.ENVIRONMENT} -Dheadless=${params.HEADLESS_MODE}"
                        }
                    }
                }
            }
        }

        stage('Reports') {
            steps {
                dir('java-selenium-automation') {
                    script {
                        try {
                            archiveArtifacts artifacts: 'target/surefire-reports/**/*,reports/**/*', allowEmptyArchive: true
                            junit testResults: 'target/surefire-reports/*.xml', allowEmptyResults: true
                        } catch (Exception e) {}
                    }
                }
            }
        }

        stage('Notification') {
            steps {
                dir('java-selenium-automation') {
                    script {
                        try {
                            // Find the latest HTML report
                            def reportFiles = findFiles(glob: 'reports/*.html')
                            def latestReport = reportFiles.size() > 0 ? reportFiles[-1].path : null
                            
                            emailext(
                                subject: "Java Selenium Web Test - ${currentBuild.currentResult}",
                                body: """<html>
                                    <body>
                                        <h2>Java Selenium Web Test Report</h2>
                                        <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
                                        <p><strong>Status:</strong> ${currentBuild.currentResult}</p>
                                        <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
                                        <p><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                                        <hr>
                                        <p><strong>Test Suite:</strong> ${params.TEST_SUITE}</p>
                                        <p><strong>Browser:</strong> ${params.BROWSER_TYPE}</p>
                                        <p><strong>Environment:</strong> ${params.ENVIRONMENT}</p>
                                        <p><strong>Headless Mode:</strong> ${params.HEADLESS_MODE}</p>
                                        <hr>
                                        <p><strong>Attachments:</strong> See attached report.html and build.log</p>
                                        <p>Test reports are archived in Jenkins artifacts.</p>
                                    </body>
                                </html>""",
                                to: "ashokchandravanshi1988@gmail.com",
                                mimeType: 'text/html',
                                attachLog: true,
                                attachmentsPattern: latestReport ?: '',
                                replyTo: 'ashokchandravanshi1988@gmail.com'
                            )
                        } catch (Exception e) {
                            echo "Notification failed: ${e.getMessage()}"
                        }
                    }
                }
            }
        }
    }

    post {
        always { cleanWs() }
        success { echo "Pipeline completed successfully!" }
        failure { echo "Pipeline failed!" }
    }
}
